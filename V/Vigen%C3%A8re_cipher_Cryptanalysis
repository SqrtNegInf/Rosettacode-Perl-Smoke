#!/usr/local/bin/perl
#u# http://rosettacode.org/wiki/Vigen√®re_cipher/Cryptanalysis
#c# 2019-12-17 <RC
#p# OK
#n# submitter translated from julia (?), I've clean up a bit
#n# runs, but the scoring sytem is wacky?

my @res;

use Data::Printer;

use strict;
use warnings;
use feature 'say';

# specify how many keylengths to try; based on this will pick the most probable decrypt the message
my $max_key_lengths = 5;

# only decoding in this task
use constant decode => -1;

sub myguess {
    my ($text) = (@_);
    my ($seqtext, $i, @guesses_ranked, @spacing, @factors, @sortedfactors, $pos, %freq, %chi);

    # letter frequencies, from Wikipedia
    my %EnglishLetterFreq = (
        'E'=>12.70, 'L'=>4.03, 'Y'=>1.97, 'P'=>1.93, 'T'=>9.06, 'A'=>8.17, 'O'=>7.51, 'I'=>6.97, 'N'=>6.75, 
        'S'=>6.33,  'H'=>6.09, 'R'=>5.99, 'D'=>4.25, 'C'=>2.78, 'U'=>2.76, 'M'=>2.41, 'W'=>2.36, 'F'=>2.23, 
        'G'=>2.02,  'B'=>1.29, 'V'=>0.98, 'K'=>0.77, 'J'=>0.15, 'X'=>0.15, 'Q'=>0.10, 'Z'=>0.07
    );

    # Kasiski's search
    $seqtext = $text;
    while ($seqtext =~ /(...).*\1/) {
        $i = index($seqtext, $1);
        $pos += $i++;
        $seqtext = substr($seqtext, $i);
        $pos++;
        $i = index($seqtext, $1);
        push @spacing, $i+1;
    }

    for my $j (@spacing) {
        push @factors, grep { $j % $_ == 0 } 2..$j;
    }
    $freq{$_}++ for @factors;
    @sortedfactors = grep { $_ >= 4 } sort { $freq{$b} <=> $freq{$a} } keys %freq;

    for my $keylen ( @sortedfactors[0..$max_key_lengths-1] ) {
        my $keyguess = '';
        for (my $i = 0; $i < $keylen; $i++) {
            my($mykey, %chivalues, $bestchi, $bestguess);
            for (my $j = 0; $j < length($text); $j += $keylen) {
                $mykey .= substr($text, ($j+$i) % length($text), 1);
            }

            for my $subkey ('A'..'Z') {
                my $chi = 0;
                my $decrypted = mycrypt($mykey, $subkey);
                my $length    = length($decrypted);
                for my $char ('A'..'Z') {
                    my $count = 0;
                    my $expected = $EnglishLetterFreq{$char} * $length / 100;
                    ++$count while $decrypted =~ /\Q$char/g;
                    $chivalues{$subkey} += ($count - $expected)**2 / $expected unless !$count;
                }
            }
            for my $sk (keys %chivalues) {
                if (!$bestchi or $chivalues{$sk} < $bestchi) {
                    $bestchi   = $chivalues{$sk};
                    $bestguess = $sk;
            $chi{$keylen}{key}   = $keyguess . $bestguess;
            $chi{$keylen}{score} = $chivalues{$sk};
                }
            }
            $keyguess .= $bestguess;
#p %chivalues; exit;
#printf "kg: $keyguess ::  bestchi: %d\n" , int $bestchi;
        }
    }
    p %chi; exit;
    push @guesses_ranked, sort { $chi{$a} <=> $chi{$b} } keys %chi;
    return @guesses_ranked;
}

sub mycrypt {
    my ($text, $key) = @_;
    my ($newtext, %values_numbers);

    my $keylen = length($key);
    @values_numbers{'A'..'Z'} = 0..25;
    my %values_letters = reverse %values_numbers;

    for (my $i = 0; $i < length($text); $i++) {
        my $val =  decode * $values_numbers{substr( $key, $i%$keylen, 1)}
                 +          $values_numbers{substr($text, $i,         1)};
        $newtext .= $values_letters{ $val % 26 };
    }
    return $newtext;
}

my $ciphertext = <<~'EOD';
    MOMUD EKAPV TQEFM OEVHP AJMII CDCTI FGYAG JSPXY ALUYM NSMYH
    VUXJE LEPXJ FXGCM JHKDZ RYICU HYPUS PGIGM OIYHF WHTCQ KMLRD
    ITLXZ LJFVQ GHOLW CUHLO MDSOE KTALU VYLNZ RFGBX PHVGA LWQIS
    FGRPH JOOFW GUBYI LAPLA LCAFA AMKLG CETDW VOELJ IKGJB XPHVG
    ALWQC SNWBU BYHCU HKOCE XJEYK BQKVY KIIEH GRLGH XEOLW AWFOJ
    ILOVV RHPKD WIHKN ATUHN VRYAQ DIVHX FHRZV QWMWV LGSHN NLVZS
    JLAKI FHXUF XJLXM TBLQV RXXHR FZXGV LRAJI EXPRV OSMNP KEPDT
    LPRWM JAZPK LQUZA ALGZX GVLKL GJTUI ITDSU REZXJ ERXZS HMPST
    MTEOE PAPJH SMFNB YVQUZ AALGA YDNMP AQOWT UHDBV TSMUE UIMVH
    QGVRW AEFSP EMPVE PKXZY WLKJA GWALT VYYOB YIXOK IHPDS EVLEV
    RVSGB JOGYW FHKBL GLXYA MVKIS KIEHY IMAPX UOISK PVAGN MZHPW
    TTZPV XFCCD TUHJH WLAPF YULTB UXJLN SIJVV YOVDJ SOLXG TGRVO
    SFRII CTMKO JFCQF KTINQ BWVHG TENLH HOGCS PSFPV GJOKM SIFPR
    ZPAAS ATPTZ FTPPD PORRF TAXZP KALQA WMIUD BWNCT LEFKO ZQDLX
    BUXJL ASIMR PNMBF ZCYLV WAPVF QRHZV ZGZEF KBYIO OFXYE VOWGB
    BXVCB XBAWG LQKCM ICRRX MACUO IKHQU AJEGL OIJHH XPVZW JEWBA
    FWAML ZZRXJ EKAHV FASMU LVVUT TGK
EOD

my $text = uc($ciphertext) =~ s/[^A-Z]//gr;

#say join "\n", myguess($text); exit;

for my $key ( myguess($text) ) {
    my $head = substr(mycrypt($text, $key), 0, 80);
    push @res, "Key:       " . $key  . "\n". 
               "Plaintext: " . $head . "\n";
}

say my $result = join "\n", @res;
exit;

my $ref = << 'END';
Key: EC
Plaintext: IMISZCGYLTPOADIMATDNWHIGEAZAPGBEUYCHONTWWJQWILOKUFRSTHAJANTHBVCAIHDIZXNWEAQFUNQQLEEEIMEWDDSFPAMIIJNBERHVVJFDROCFKJSAQFHMIBOMAIPYHSRWHLVPBEXVLFREWJSOEQBENNDHKMBUCSXWEJWNHYHAWDWYIIHEYCPBSTKCHHEICHXVLFREWJSOYQJUXSXWDAQFGMYCTHAWGZMIRWGGECDENJCFTCKJSYSDKHEJKTRPDNGBSGDIJYPSDLRPUYMBETDVBFNXROSKSTHEOFJLHTVQFJWIEDDVQDTHHVIRXJMTNVTFNDVVCTHPWHECTNNTKQILLIANZRHNNUIHWXLIHOQXWYHEVVCTHIHEFRQGERZQQPAXTHAPTXOFINORIRAMANWNFFOKBLXWROQXWYHEWWZLINWOKUPSDBXTPQISASEKRFMERPSYADONAKLTANGVVWSJGHWESYHRRWUMXWEVKIEFLBOCRJATNTOEXHKEUUBFGZHEHVUYITGGOIECDWEKWNTSKGOILTWEJKVFLUPRVNRVBAYBPSDHDUHYLDUSHRXSTHHLOGFTRWKTZHOMHVCRCPRMODNGEAPKGMFDYOBIPGJOXURFCRALHFDMCAONODLTCHKIIQEDLPVNWYOYPNPXBRLNZNKPNDPYTXLIWJMYSKESZZSLYRHCBIKXMBHVXSTHHYOGIPLLIZBXYWHTSYLTBONFVTVEVCBIXWEMKDTWATKUCZXVRAXVXYSEHOGAIGYPNVIYYSKGGFMSWHAEHMEHDFTNRXSHAUXYBUWKHXVPTHAIWFRDWQISHTRSPRCI

Key: THECSAS
Plaintext: THISLESHIRRYENTHATPPIQFEGKDKABBEGAOQLLVGATBRILAMGOOQVRETLITHNXOJFFFSDHYREACHGWNONOIOTHEWPFEOMYOSMTYWERTXHSCBTYGPVESACHTVFZQWESATHSDYTUSNDOBFWAREILEXBODORXOCKMNWOBUUGTAXSTHAIFIHFGJOCMAWSTWETQBGERBFWAREILEXVOLEBCIRDACHSVVAVREGRUMIDYSPBAFORTNATCWLEHPBMRITVORPPPSKPEFSNIANDLDRGHJZGDHFMANXDQETPRJOSPUGHTHSRSTGGNHFBYTHTXUAUHODRFEANDHXOCENYRIMEINTWSUUIGCXDBSINUUJIGIGJYUHHTHEHXOCEGJOJBBBERLSCYXVVREZESOFUPAAFPCWEXHIFFAMNUUUTYUHHTHEIYLUFLYYOEANDBJVBZFQCCIUCAMEDREHXBQXEUWOANSXHFPHIRAODTHRDYGVUUGFOSPALBAEDSXRPDSOICKEGWNODXJOLFFTITSIARBAFGIUHITSWIARIRYONUGALUBTHWOTDKCLANDHPWTHIBWCLBINTHTNAPCRTGODKCOMTXOAZNTWSNYBEABMSVCBAYFSABJOJWDOZPCVLPOHCAAPAMIREROSTLEDXRHWTWQITXASBRXPLWHNPNTIESLIILYHPIGCDJDGYRTENRHVOLLFINTHTAAPFNNVMJMSYWTVEHIRDYRPGOVEHENRUUGWONERATWWOIUTTKBFITSETQSJFEAZRFTTYSWISOJQYREOSHEHPHFWOVUREEITBUIMTGSNVRESHARDISUBERTCTBND

Key: THECHESHIRECAT
Plaintext: THISWASTHEPOEMTHATALICEREADJABBERWOCKYTWASBRILLIGANDTHESLITHYTOVESDIDGYREANDGIMBLEINTHEWABEALLMIMSYWERETHEBOROGOVESANDTHEMOMERATHSOUTGRABEBEWARETHEJABBERWOCKMYSONTHEJAWSTHATBITETHECLAWSTHATCATCHBEWARETHEJUBJUBBIRDANDSHUNTHEFRUMIOUSBANDERSNATCHHETOOKHISVORPALSWORDINHANDLONGTIMETHEMANXOMEFOEHESOUGHTSORESTEDHEBYTHETUMTUMTREEANDSTOODAWHILEINTHOUGHTANDASINUFFISHTHOUGHTHESTOODTHEJABBERWOCKWITHEYESOFFLAMECAMEWHIFFLINGTHROUGHTHETULGEYWOODANDBURBLEDASITCAMEONETWOONETWOANDTHROUGHANDTHROUGHTHEVORPALBLADEWENTSNICKERSNACKHELEFTITDEADANDWITHITSHEADHEWENTGALUMPHINGBACKANDHASTTHOUSLAINTHEJABBERWOCKCOMETOMYARMSMYBEAMISHBOYOFRABJOUSDAYCALLOOHCALLAYHECHORTLEDINHISJOYTWASBRILLIGANDTHESLITHYTOVESDIDGYREANDGIMBLEINTHEWABEALLMIMSYWERETHEBOROGOVESANDTHEMOMERATHSOUTGRABEITSEEMSVERYPRETTYSHESAIDWHENSHEHADFINISHEDITBUTITSRATHERHARDTOUNDERSTAND

Key: THEC
Plaintext: THISKXGYWOPOLYIMLODNHCIGPVZAABBEFTCHZITWHEQWTGOKFARSECAJLITHMQCATCDIKSNWPVQFFIQQWZEETHEWOYSFAVMITENBPMHVGEFDCJCFVESABAHMTWOMLDPYSNRWSGVPMZXVWAREHESOPLBEYIDHVHBUNNXWPEWNSTHAHYWYTDHEJXPBDOKCSCEINCXVWAREHESOJLJUINXWOVQFRHYCECAWRUMICRGGPXDEYECFEXKJDTSDVCEJVORPOIGBDBDIUTPSOGRPFTMBPODVMANXCJSKDOHEZAJLSOVQQEWIPYDVBYTHSQIRIEMTYQTFYYVVNOHPHCECEINTVLILWDANKMHNYPIHHSLISJQXHTHEGQCTSDHEQMQGPMZQBKAXECAPESOFTIORTMAMLIWNQAOKMGXWCJQXHTHEHRZLTIWOVPPSOWXTALISLNEKCAMECKSYLYONLFLTLIGVGRSJRCWEDTHRCRUMIREVVDEFWWOCCEATYOOEICKEFPBFRUHESQUYTOGGZDECOREKHITSVBOIWOWEUFVFWPPRGIRVMVYBANDHOPHYWYUSSMXSECHLZBFTCRKTKCOMSQCRNKRMZYNGPVPKRHFDJJBIABJOIPRFNMALSADMNVONZYLTNCKITLEDWKVNHTOYAIPXMMLNKIKPYYPYESLIHEMYDFESKUSLJMHCMDKXXWHVINTHSTOGTKLLTUBXJRHTDTLTMJNFGOVEGXBIIREMVYTWLOKUNUXVCVXVITSESJGATBYPYQIYJNKGRAMSHCAESHEHOATNCSSHLPXYMPWKSSVPECAIHARDHLISSORSAMCI

END
#Key: THECHESCIRECATTHECHESHIRECAT
#Plaintext: THISWASYHEPOEMTHATALICEREADJABBERWOHKYTWASBRILLIGANDTHESLITHYTOAESDIDGYREANDGIMBLEINTHEWABEFLLMIMSYWERETHEBOROGOVESANDTMEMOMERATHSOUTGRABEBEWARETHEOABBERWOCKMYSONTHEJAWSTHATBIYETHECLAWSTHATCATCHBEWARETHEOUBJUBBIRDANDSHUNTHEFRUMIOUSGANDERSNATCHHETOOKHISVORPALSBORDINHANDLONGTIMETHEMANXOMEKOEHESOUGHTSORESTEDHEBYTHETURTUMTREEANDSTOODAWHILEINTHOULHTANDASINUFFISHTHOUGHTHESTOTDTHEJABBERWOCKWITHEYESOFFLARECAMEWHIFFLINGTHROUGHTHETULLEYWOODANDBURBLEDASITCAMEONEYWOONETWOANDTHROUGHANDTHROUGMTHEVORPALBLADEWENTSNICKERSNFCKHELEFTITDEADANDWITHITSHEAIHEWENTGALUMPHINGBACKANDHASTYHOUSLAINTHEJABBERWOCKCOMETORYARMSMYBEAMISHBOYOFRABJOUSDFYCALLOOHCALLAYHECHORTLEDINHNSJOYTWASBRILLIGANDTHESLITHYYOVESDIDGYREANDGIMBLEINTHEWAGEALLMIMSYWERETHEBOROGOVESANITHEMOMERATHSOUTGRABEITSEEMSAERYPRETTYSHESAIDWHENSHEHADFNNISHEDITBUTITSRATHERHARDTOUSDERSTAND

use Test::More;
chomp $ref;
is($result, $ref);
done_testing();
